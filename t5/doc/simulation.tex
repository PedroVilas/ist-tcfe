\section{Simulation Analysis}
\label{sec:simulation}

The main circuit used to simulate the output impedance of the amplifier as a whole was the one that can be found in the following figure (repeteated from the analysis section).

\begin{figure}[h] \centering
\includegraphics[width=0.95\linewidth]{diagram_t5.pdf}
%\vspace{-7cm}
\caption{Diagram of the circuit considered for the computations and simulations.}
\label{fig:diagram_t5_2}
\end{figure}

At the begin of this laboratory assigment we translated this circuit to the Ngspyce language. Then, we ensured that all the correct plots where printed correctly and also we automated the merit computation. Only then, after these processes explained before, we work in the formulas that we referred in the last section in order to work on a solution that gave us the desired pass band (at 1kHz), as well as the desired (40dB) gain. 

As the objective all along was to maximize the Ngspice merit, and not the theoretical one, we focussed on improving this figure. Focusing on that led us to opting for some alternative combinations that appearantly don't seem to be correct but worked in practice. This process was quite iterative, due to a solid grasp on the concept of cutoff frquencies and how they should be altered by the variation of the corresponding resistor or capacitor, we managed to achieve a relatively central frquency at 1kHz. The gain was easier to fine-tune, with a relatively simple expression $1+\frac{R_3}{R_4}$ (this is just the gain from the OPAMP); here the limiting factor really was the limitation in terms of available resistors.

In the next table we reproduce the results for the final setup we settled on, already listed in the previous section, though hopefully here seen in new light. 


\hfill
 \parbox{1\linewidth}{
  \centering
  \begin{tabular}{|l|l|r|}
    \hline    
    {\bf Parameter} & {\bf Value} & {\bf Units }\\ \hline
    \input{values.tex}
  \label{tab:params2}
  \end{tabular}
  }
\par

\hfill
 \parbox{1\linewidth}{
  \centering
  \begin{tabular}{|l|l|l|r|}
    \hline    
    {\bf Parameter} & {\bf Simulation} & {\bf Theoretical } & {\bf Units }\\ \hline
    \input{merit.tex}
  \label{tab:results2}
  \end{tabular}
  }
  
  For a more complete overview and comparison of the results, refer back to the previous section, where this discussion has been drawn out in quite some detail.

  
Next we present a number of plots, obtained from the Ngspice simulation, that help to illustrate the circuit's behaviour. Note in particular how the difference to the theoretical gain is here quite evident, and in particular how the phase bode plot is completely different.
  
\par
\vspace{-4cm}
\begin{figure}[H] \centering
\includegraphics[width=0.6\linewidth]{vdb_out.pdf}
\vspace{-1cm}
\caption{Output voltage gain frequency response - note the 40 dB gain in the passband.}
\label{fig:gain_sim}
\end{figure}


\begin{figure}[H] \centering
\includegraphics[width=0.5\linewidth]{vout.pdf}
\caption{The input and output signals, superimposed. The sheer scale of the amplification is evident here (the input, given the linear scale, is nearly a straight line with but only little ondulation around zero). The y axis is in V. Note that this graph is for the transient analysis, for which the voltage source only puts out 10mV, that with a gain of around $10^{2}$ goes to somewhere around 1V.}
\label{fig:In_imp}
\end{figure}
\vspace{-3cm}


\begin{figure}[H] \centering
\includegraphics[width=0.5\linewidth]{vp_out.pdf}
\caption{Phase bode plot of the circuit. Note how the plot decreases from plus 90 degrees down to zero, followed by a full 180 degree drop and finally another 90 degree drop, back to the initial plus 90 degrees phase. This indicates the existence of an additional two poles in the OPAMP model, not present in the ideal model we used for the theory section. If you remember the theoretical bode plot we obtained from octave, it is completely different! Note also that there is no discontinuity in this plot, it is just the way Ngspice presents the output of the arg() funtion, in the domain -180 degrees to 180 degrees.}
\label{fig:out_imp}
\end{figure}
\vspace{-3cm}


\pagebreak
